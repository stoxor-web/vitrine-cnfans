<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TRENDY WORLD SHOP</title>
  <style>
    /* Reset et layout global */
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
    }
    :root {
      --marquee-duration: 45s;
      --marquee-gap: 100px;
    }
    a { text-decoration: none !important; color: inherit; }
    header { background-color: #111827; color: white; padding: 20px; text-align: center; position: relative; }

    /* Marquee */
    .marquee { background: red; overflow: hidden; white-space: nowrap; }
    .marquee .msg {
      display: inline-block;
      padding-left: 100%;
      margin-right: var(--marquee-gap);
      animation: scroll var(--marquee-duration) linear infinite;
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    @keyframes scroll {
      from { transform: translateX(0); }
      to   { transform: translateX(-100%); }
    }

    /* Réseaux sociaux */
    .social-banner {
      background:#808080; text-align:center; padding:10px 0;
    }
    .social-banner a img {
      width:40px; height:40px; margin:0 10px; vertical-align:middle;
    }

    /* Filtres */
    .filters {
      text-align:center;
      padding:20px;
    }
    /* Groupe de boutons « pill » */
    .pill-group {
      display:inline-flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:16px;
    }
    .pill {
      padding:8px 16px;
      font-size:14px;
      border:1px solid #ddd;
      border-radius:9999px;
      background:#fff;
      cursor:pointer;
      transition:
        background-color .3s,
        color .3s,
        border-color .3s;
    }
    .pill:hover {
      background:#007bff;
      color:#fff;
      border-color:#007bff;
    }
    .pill.active {
      background:#007bff;
      color:#fff;
      border-color:#007bff;
    }
    /* Les autres filtres gardent leur style */
    .filters select {
      padding:12px 20px;
      font-size:16px;
      border-radius:25px;
      border:2px solid #ddd;
      margin:0 10px 20px;
      transition:.3s;
    }
    .filters select:hover {
      border-color:#007bff;
      background:#f0f8ff;
    }

    /* Grille & cartes */
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
      gap:20px; padding:20px; max-width:1200px; margin:auto;
    }
    .product {
      background:#fff; border-radius:10px; overflow:hidden;
      box-shadow:0 2px 10px rgba(0,0,0,.05); text-align:center;
      transition:transform .2s ease; position: relative;
    }
    .product:hover { transform:translateY(-5px); }
    .product-brand {
      position:absolute; top:10px; left:10px;
      background:rgba(0,0,0,0.6); color:#fff; padding:3px 8px;
      font-size:12px; font-weight:bold; border-radius:4px;
    }
    .product img {
      width:100%; height:220px; object-fit:contain;
    }
    .product-title { padding:10px; font-size:16px; font-weight:bold; color:#333; }
    .product-price { padding:10px; font-size:16px; font-weight:bold; color:#000; }
    .product-colors { padding:5px 0; }
    .color-circle {
      display:inline-block; width:14px; height:14px;
      border-radius:50%; margin:0 3px; border:1px solid #ccc;
    }

    /* Responsives */
    @media(max-width:768px) {
      .grid { grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; }
      .product-title{font-size:14px;}
      .product-price{font-size:12px;}
    }
    @media(max-width:480px) {
      .grid{grid-template-columns:1fr;gap:10px;}
      .filters select{width:160px;margin-bottom:15px;}
      .pill { font-size:12px; padding:6px 12px; }
    }
  </style>
</head>
<body>

  <header>
    <h1>TRENDY WORLD SHOP</h1>
    <div class="marquee">
      <span class="msg">
        En cliquant sur un article, vous serez automatiquement redirigé vers le site CNFANS · Clicking on an article will automatically redirect you to the CNFANS website
      </span>
      <span class="msg">
        Attention, les prix affichés ne comprennent pas les frais de livraison · Prices exclude shipping
      </span>
    </div>
  </header>

  <div class="social-banner">
    <a href="https://cnfans.com/register?ref=212491" target="_blank">
      <img src="https://spreadsheetcnfans.my.canva.site/_assets/media/2ee61dcee3eb5c104658e8ee50dd3ba2.png" alt="CNFANS">
    </a>
    <a href="https://www.tiktok.com/@trendy_world_off" target="_blank">
      <img src="https://cdn.pixabay.com/photo/2021/01/30/06/43/tiktok-5962993_1280.png" alt="TikTok">
    </a>
    <a href="https://www.instagram.com/trendy_world_off/" target="_blank">
      <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram">
    </a>
    <a href="https://youtu.be/n_2sIEApRhk?si=wGym7D6Deui_vARg&t=12" target="_blank">
      <img src="https://cdn.iconscout.com/icon/free/png-256/free-youtube-104-432560.png?f=webp" alt="YouTube">
    </a>
    <a href="https://chromewebstore.google.com/detail/ljipkdpcjbmhkdjjmbbaggebcednbbme" target="_blank">
      <img src="https://lh3.googleusercontent.com/gQPpVsreSTA080X1qhyxMUJ5YGqJGHnbhaw-Xm9sG-iHRrNvKVi-bvlPEyJRjrlpeKAEPz6igxqqIvTlml5MSHSm1m0=s120" alt="Extension Chrome">
    </a>
  </div>

  <div class="filters">
    <!-- Boutons catégories -->
    <div id="categoryButtons" class="pill-group">
      <!-- JS injectera ici les .pill -->
    </div>

    <!-- Sélecteurs restants -->
    <select id="brandFilter" onchange="filterProducts()">
      <option value="all">Marques</option>
    </select>
    <select id="sortSelect" onchange="filterProducts()">
      <option value="none">Trier par</option>
      <option value="price-asc">Prix croissant</option>
      <option value="price-desc">Prix décroissant</option>
    </select>
  </div>

  <div class="grid" id="productGrid"></div>

  <script>
    // (1) Heure de Paris & shuffle déterministe (inchangés)…
    const MS12H = 12 * 3600 * 1000;
    function getParisMs(){
      const fmt = new Intl.DateTimeFormat('sv-SE',{
        timeZone:'Europe/Paris',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit',
        hour12:false
      }).format(new Date()).replace(' ','T');
      return new Date(fmt).getTime();
    }
    const blockIndex = Math.floor(getParisMs()/MS12H);
    function mulberry32(a){ return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t^(t>>>15), t|1);
      t ^= t + Math.imul(t^(t>>>7), t|61);
      return ((t^(t>>>14))>>>0)/4294967296;
    }}
    function seededShuffle(arr, seed){
      const rand = mulberry32(seed), a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rand()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // (2) Chargement & conversion CNY→EUR 24h cache…
    let products = [], categories = [], brands = [], colors = [];
    let rateEUR = 0.13;
    async function getRateCNYtoEUR(){
      const now = Date.now(), ts = +localStorage.getItem('rateTimestamp')||0;
      const saved = parseFloat(localStorage.getItem('rateEUR'))||0;
      if(saved && now - ts < 24*3600*1000) return saved;
      try {
        const r = await fetch('https://api.exchangerate.host/latest?base=CNY&symbols=EUR'),
              j = await r.json(),
              rt = j.rates.EUR;
        localStorage.setItem('rateEUR', rt);
        localStorage.setItem('rateTimestamp', now);
        return rt;
      } catch(e){
        console.warn('taux off:', e);
        return saved||rateEUR;
      }
    }

    const pRate       = getRateCNYtoEUR().then(r=>rateEUR=r),
          pCategories = fetch('categories.json').then(r=>r.json()).then(d=>categories=d.sort((a,b)=>a.localeCompare(b,'fr'))),
          pBrands     = fetch('brands.json').then(r=>r.json()).then(d=>brands=d.sort((a,b)=>a.localeCompare(b,'fr'))),
          pColors     = fetch('colors.json'   ).then(r=>r.json()).then(d=>colors=d).catch(()=>{}),
          pProducts   = fetch('jadeship_products.json').then(r=>r.json()).then(d=>products=d);

    Promise.all([pRate,pCategories,pBrands,pColors,pProducts])
      .then(initFilters)
      .then(filterProducts)
      .catch(console.error);

    // (3) Initialisation des filtres
    function initFilters(){
      const cb = document.getElementById('categoryButtons');
      // Bouton "Toutes"
      const all = createPill('all','Toutes');
      all.classList.add('active');
      cb.appendChild(all);

      categories.forEach(cat=>{
        cb.appendChild(createPill(cat, cat));
      });

      // Remplissage du sélecteur marques
      const bf = document.getElementById('brandFilter');
      brands.forEach(b=> bf.appendChild(new Option(b,b)));
    }

    function createPill(value,label){
      const btn = document.createElement('button');
      btn.className = 'pill';
      btn.textContent = label;
      btn.dataset.category = value;
      btn.onclick = ()=>{
        document.querySelectorAll('.pill-group .pill').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        filterProducts();
      };
      return btn;
    }

    // (4) Filtrer & trier
    function filterProducts(){
      const cat = document.querySelector('.pill-group .pill.active').dataset.category;
      const br  = document.getElementById('brandFilter').value;
      const sort= document.getElementById('sortSelect').value;
      let list = products.filter(p=>
        (cat==='all'||p.category===cat) &&
        (br==='all'||p.brand===br)
      );
      if(sort==='price-asc')      list.sort((a,b)=>a.price - b.price);
      else if(sort==='price-desc') list.sort((a,b)=>b.price - a.price);
      displayProducts(list);
    }

    // (5) Affichage
    function displayProducts(list){
      const grid = document.getElementById('productGrid');
      grid.innerHTML='';
      const shuffled = seededShuffle(list, blockIndex);
      shuffled.forEach(p=>{
        const priceEUR = (p.price * rateEUR).toFixed(1).replace('.',',');
        const circles = (p.colors||[]).map(c=>
          `<span class="color-circle" style="background:${c}"></span>`
        ).join('');
        const a = document.createElement('a');
        a.className  = 'product';
        a.href       = p.cnfans_link;
        a.target     = '_blank';
        a.innerHTML  = `
          <div class="product-brand">${p.brand}</div>
          <img src="${p.image}" alt="${p.title}">
          <div class="product-title">${p.title}</div>
          <div class="product-price">${priceEUR} €</div>
          <div class="product-colors">${circles}</div>
        `;
        grid.appendChild(a);
      });
    }
  </script>

</body>
</html>
