<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Produits CNFANS</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    input, select { width: 100%; padding: 5px; box-sizing: border-box; }
    select[multiple] { height: 100px; }
    button { margin: 5px; padding: 6px 12px; }
    th.price-column, td.price-column { width: 80px; max-width: 80px; }
    #addBtn {
      position: fixed; bottom: 20px; right: 20px; z-index: 1000;
      width: 50px; height: 50px; border-radius: 50%; background-color: #007bff;
      color: white; font-size: 24px; border: none; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: background-color 0.2s;
    }
    #addBtn:hover { background-color: #0056b3; }
    #pw-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); display: flex;
      justify-content: center; align-items: center; z-index:1000;
    }
    #pw-prompt {
      background: #fff; padding: 20px; border-radius: 8px;
      text-align: center; width: 300px;
    }
    #pw-prompt input { width: calc(100% - 20px); padding: 8px; margin-bottom: 10px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
  <!-- Overlay mot de passe -->
  <div id="pw-overlay">
    <div id="pw-prompt">
      <h2>Acc√®s Admin</h2>
      <input type="password" id="adminPwd" placeholder="Entrez le mot de passe">
      <br>
      <button onclick="checkPwd()">Valider</button>
      <p id="timerMsg">Vous avez 15 secondes pour saisir le mot de passe...</p>
    </div>
  </div>

  <header><h1>üõ†Ô∏è Interface Admin ‚Äì Produits CNFANS</h1></header>

  <input type="file" id="fileInput" accept=".json"><br><br>
  <button id="addBtn" title="Ajouter un produit" onclick="addProduct()">Ôºã</button>
  <button onclick="downloadJSON()">üíæ T√©l√©charger JSON</button>

  <table id="productTable">
    <thead>
      <tr>
        <th>Titre</th><th>Plateforme</th><th>ID</th><th>Image</th>
        <th>Cat√©gorie</th><th>Marque</th><th>Couleurs</th>
        <th class="price-column">Prix (‚Ç¨)</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>

  <script>
    // --- Gestion du mot de passe ---
    const correctPwd = '123456';
    let pwdTimer;
    window.onload = () => {
      pwdTimer = setTimeout(()=>{
        alert('Temps √©coul√©, acc√®s refus√©.');
        window.location.href = 'index.html';
      }, 15000);
    };
    function checkPwd(){
      if(document.getElementById('adminPwd').value === correctPwd){
        clearTimeout(pwdTimer);
        document.getElementById('pw-overlay').style.display = 'none';
      } else {
        alert('Mot de passe incorrect');
      }
    }

    // --- Donn√©es dynamiques ---
    let products = [], brands = [], categories = [], colors = [];

    // Charger cat√©gories
    fetch('categories.json')
      .then(r => r.json())
      .then(d => categories = d.sort((a,b)=>a.localeCompare(b,'fr')))
      .catch(console.error);

    // Charger marques
    fetch('brands.json')
      .then(r => r.json())
      .then(d => brands = d.sort((a,b)=>a.localeCompare(b,'fr')))
      .catch(console.error);

    // Charger couleurs
    fetch('colors.json')
      .then(r => r.json())
      .then(d => colors = d)
      .catch(console.error);

    // Charger produits
    document.getElementById('fileInput').addEventListener('change', e => {
      const reader = new FileReader();
      reader.onload = () => {
        products = JSON.parse(reader.result);
        renderTable();
        enableDragAndDrop();
      };
      reader.readAsText(e.target.files[0]);
    });

    function renderTable(){
      const tbody = document.getElementById('productTableBody');
      tbody.innerHTML = '';

      products.forEach((p, i) => {
        const row = document.createElement('tr');

        // Colonnes texte
        ['title','platform','id','image'].forEach(field => {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.value = p[field] || '';
          inp.onchange = e => products[i][field] = e.target.value;
          td.appendChild(inp);
          row.appendChild(td);
        });

        // Cat√©gorie (dynamic)
        const catTd = document.createElement('td');
        const catSel = document.createElement('select');
        categories.forEach(c => {
          const o = document.createElement('option');
          o.value = o.textContent = c;
          if(p.category === c) o.selected = true;
          catSel.appendChild(o);
        });
        catSel.onchange = e => products[i].category = e.target.value;
        catTd.appendChild(catSel);
        row.appendChild(catTd);

        // Marque (dynamic)
        const brTd = document.createElement('td');
        const brSel = document.createElement('select');
        brands.forEach(b => {
          const o = document.createElement('option');
          o.value = o.textContent = b;
          if(p.brand === b) o.selected = true;
          brSel.appendChild(o);
        });
        brSel.onchange = e => products[i].brand = e.target.value;
        brTd.appendChild(brSel);
        row.appendChild(brTd);

        // Couleurs (multi-select)
        const colTd = document.createElement('td');
        const colSel = document.createElement('select');
        colSel.multiple = true;
        colors.forEach(c => {
          const o = document.createElement('option');
          o.value = c.code;
          o.textContent = c.name;
          if(Array.isArray(p.colors) && p.colors.includes(c.code)) o.selected = true;
          colSel.appendChild(o);
        });
        colSel.onchange = e => {
          products[i].colors = Array.from(e.target.selectedOptions).map(x=>x.value);
        };
        colTd.appendChild(colSel);
        row.appendChild(colTd);

        // Prix
        const prTd = document.createElement('td');
        prTd.classList.add('price-column');
        const prInp = document.createElement('input');
        prInp.type = 'number';
        prInp.step = '0.01';
        prInp.value = p.price || 0;
        prInp.onchange = e => products[i].price = parseFloat(e.target.value);
        prTd.appendChild(prInp);
        row.appendChild(prTd);

        // Actions
        const actTd = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóë Supprimer';
        delBtn.onclick = () => deleteProduct(i);
        actTd.appendChild(delBtn);
        row.appendChild(actTd);

        tbody.appendChild(row);
      });
    }

    // Drag & drop
    function enableDragAndDrop(){
      new Sortable(document.getElementById('productTableBody'), {
        animation: 150,
        onEnd: evt => {
          const [moved] = products.splice(evt.oldIndex, 1);
          products.splice(evt.newIndex, 0, moved);
        }
      });
    }

    // Ajouter un produit
    function addProduct(){
      products.push({
        title: '', platform: '', id: '', image: '',
        category: categories[0] || '',
        brand: brands[0] || '',
        colors: [], price: 0,
        cnfans_link:'', source:''
      });
      renderTable();
    }

    // Supprimer
    function deleteProduct(i){
      products.splice(i,1);
      renderTable();
    }

    // T√©l√©charger JSON
    function downloadJSON(){
      products.forEach(p => {
        p.cnfans_link = `https://cnfans.com/product?platform=${p.platform}&id=${p.id}&ref=212491`;
        p.source     = `https://www.cnfans.com/product?id=${p.id}&platform=${p.platform}`;
      });
      const blob = new Blob([JSON.stringify(products, null, 2)], { type:'application/json' });
      const a    = document.createElement('a');
      a.href     = URL.createObjectURL(blob);
      a.download = 'jadeship_products.json';
      a.click();
    }
  </script>
</body>
</html>
