<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Produits CNFANS</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 5px; box-sizing: border-box; }
    select[multiple] { height: 100px; }
    button { margin: 5px; padding: 6px 12px; }
    th.price-column, td.price-column { width: 80px; max-width: 80px; }
    /* Overlay mot de passe */
    #pw-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); display: flex;
      justify-content: center; align-items: center; z-index:1000;
    }
    #pw-prompt {
      background: #fff; padding: 20px; border-radius: 8px;
      text-align: center; width: 300px;
    }
    #pw-prompt input { width: calc(100% - 20px); padding: 8px; margin-bottom: 10px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
  <!-- Overlay mot de passe -->
  <div id="pw-overlay">
    <div id="pw-prompt">
      <h2>Acc√®s Admin</h2>
      <input type="password" id="adminPwd" placeholder="Entrez le mot de passe">
      <br>
      <button onclick="checkPwd()">Valider</button>
      <p id="timerMsg">Vous avez 15 secondes pour saisir le mot de passe...</p>
    </div>
  </div>

  <header><h1>üõ†Ô∏è Interface Admin ‚Äì Produits CNFANS</h1></header>

  <input type="file" id="fileInput" accept=".json"><br><br>
  <button onclick="addProduct()">‚ûï Ajouter un produit</button>
  <button onclick="downloadJSON()">üíæ T√©l√©charger JSON</button>

  <table id="productTable">
    <thead>
      <tr>
        <th>Titre</th><th>Plateforme</th><th>ID</th><th>Image</th>
        <th>Cat√©gorie</th><th>Marque</th><th>Couleurs</th><th class="price-column">Prix (‚Ç¨)</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>

  <script>
    const correctPwd = '123456'; // <-- D√©finir ici le mot de passe
    let pwdTimer;

    // Rediriger si non valid√© en 15s
    window.onload = () => {
      pwdTimer = setTimeout(() => {
        window.location.href = 'index.html';
      }, 15000);
    };

    function checkPwd() {
      const input = document.getElementById('adminPwd').value;
      if (input === correctPwd) {
        clearTimeout(pwdTimer);
        document.getElementById('pw-overlay').style.display = 'none';
      } else {
        alert('Mot de passe incorrect');
      }
    }

    let products = [];
    let brands = [];
    let colors = [];

    // Charger marques et couleurs
    fetch('brands.json').then(r => r.json()).then(d => brands = d.sort((a, b) => a.localeCompare(b, 'fr')));
    fetch('colors.json').then(r => r.json()).then(d => colors = d);

    document.getElementById('fileInput').addEventListener('change', e => {
      const reader = new FileReader();
      reader.onload = () => {
        products = JSON.parse(reader.result);
        renderTable();
        enableDragAndDrop();
      };
      reader.readAsText(e.target.files[0]);
    });

    function renderTable() {
      const tbody = document.getElementById('productTableBody');
      tbody.innerHTML = '';

      products.forEach((p, i) => {
        const row = document.createElement('tr');

        // Colonnes titre / plateforme / id / image
        row.innerHTML = `
          <td><input value="${p.title||''}" onchange="products[${i}].title=this.value"></td>
          <td><input value="${p.platform||''}" onchange="products[${i}].platform=this.value"></td>
          <td><input value="${p.id||''}" onchange="products[${i}].id=this.value"></td>
          <td><input value="${p.image||''}" onchange="products[${i}].image=this.value"></td>
        `;
        // Cat√©gorie
        const catCell = document.createElement('td');
        const catSelect = document.createElement('select');
        ['Mode Homme','Mode Femme','Accessoires','Chaussures'].forEach(v => {
          const o = document.createElement('option');
          o.value = o.textContent = v;
          if (p.category === v) o.selected = true;
          catSelect.appendChild(o);
        });
        catSelect.onchange = e => products[i].category = e.target.value;
        catCell.appendChild(catSelect);
        row.appendChild(catCell);

        // Marque
        const brandCell = document.createElement('td');
        const brandSelect = document.createElement('select');
        brands.forEach(br => {
          const o = document.createElement('option');
          o.value = o.textContent = br;
          if (p.brand === br) o.selected = true;
          brandSelect.appendChild(o);
        });
        brandSelect.onchange = e => products[i].brand = e.target.value;
        brandCell.appendChild(brandSelect);
        row.appendChild(brandCell);

        // ** Couleurs multiple **
        const colorCell = document.createElement('td');
        const colorSelect = document.createElement('select');
        colorSelect.multiple = true;
        colors.forEach(c => {
          const o = document.createElement('option');
          o.value = c.code;        // stocke le code couleur
          o.textContent = c.name;  // affiche le nom
          if (Array.isArray(p.colors) && p.colors.includes(c.code)) {
            o.selected = true;
          }
          colorSelect.appendChild(o);
        });
        colorSelect.onchange = e => {
          // mise √† jour du tableau products[i].colors
          products[i].colors = Array
            .from(e.target.selectedOptions)
            .map(o => o.value);
        };
        colorCell.appendChild(colorSelect);
        row.appendChild(colorCell);

        // Prix
        const priceCell = document.createElement('td');
        priceCell.classList.add('price-column');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.value = p.price || 0;
        priceInput.onchange = e => products[i].price = parseFloat(e.target.value);
        priceCell.appendChild(priceInput);
        row.appendChild(priceCell);

        // Actions
        const actionCell = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóë Supprimer';
        delBtn.onclick = () => deleteProduct(i);
        actionCell.appendChild(delBtn);
        row.appendChild(actionCell);

        tbody.appendChild(row);
      });
    }

    function enableDragAndDrop() {
      new Sortable(document.getElementById('productTableBody'), {
        animation: 150,
        onEnd: evt => {
          const [moved] = products.splice(evt.oldIndex, 1);
          products.splice(evt.newIndex, 0, moved);
        }
      });
    }

    function addProduct() {
      products.push({
        title:'', platform:'', id:'', image:'',
        category:'Mode Homme',
        brand: brands[0] || '',
        colors: [],   // tableau pour plusieurs couleurs
        price:0,
        cnfans_link:'', source:''
      });
      renderTable();
    }

    function deleteProduct(i) {
      products.splice(i, 1);
      renderTable();
    }

    function downloadJSON(){
      products.forEach(p => {
        p.cnfans_link = `https://cnfans.com/product?platform=${p.platform}&id=${p.id}&ref=212491`;
        p.source     = `https://www.cnfans.com/product?id=${p.id}&platform=${p.platform}`;
      });
      const blob = new Blob([JSON.stringify(products, null, 2)], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'jadeship_products.json';
      a.click();
    }
  </script>
</body>
</html>
