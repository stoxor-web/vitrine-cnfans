<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Produits CNFANS</title>
  <style>
    /* ‚Ä¶ your existing styles ‚Ä¶ */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
  <header><h1>üõ†Ô∏è Interface Admin ‚Äì Produits CNFANS</h1></header>

  <input type="file" id="fileInput" accept=".json"><br><br>
  <button onclick="addProduct()">‚ûï Ajouter un produit</button>
  <button onclick="downloadJSON()">üíæ T√©l√©charger JSON</button>

  <table>
    <thead>
      <tr>
        <th>Titre</th><th>Plateforme</th><th>ID</th><th>Image</th>
        <th>Cat√©gorie</th><th>Marque</th><th>Couleurs</th><th>Prix (‚Ç¨)</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>

  <script>
    let products = [];
    let brands   = [];
    let colors   = [];

    // 1) Load & sort brands
    fetch('brands.json')
      .then(r => r.json())
      .then(data => { brands = data.sort((a,b)=>a.localeCompare(b, 'fr')); })
      .catch(console.error);

    // 2) Load colors
    fetch('colors.json')
      .then(r => r.json())
      .then(data => { colors = data; })
      .catch(console.error);

    // 3) Load products file
    document.getElementById('fileInput').addEventListener('change', e => {
      const reader = new FileReader();
      reader.onload = () => {
        products = JSON.parse(reader.result);
        // ensure every product has a colors array
        products.forEach(p => p.colors = p.colors || []);
        renderTable();
        enableDragAndDrop();
      };
      reader.readAsText(e.target.files[0]);
    });

    function renderTable() {
      const tbody = document.getElementById('productTableBody');
      tbody.innerHTML = '';

      products.forEach((p,i) => {
        const row = document.createElement('tr');

        // text inputs
        row.innerHTML = `
          <td><input value="${p.title}"     onchange="products[${i}].title=this.value"></td>
          <td><input value="${p.platform}"  onchange="products[${i}].platform=this.value"></td>
          <td><input value="${p.id}"        onchange="products[${i}].id=this.value"></td>
          <td><input value="${p.image}"     onchange="products[${i}].image=this.value"></td>
        `;

        // category
        const catCell = document.createElement('td');
        ['Mode Homme','Mode Femme','Accessoires','Chaussures']
          .forEach(c => {
            const o = document.createElement('option');
            o.value = o.textContent = c;
            if(p.category===c) o.selected = true;
            catCell.appendChild(o);
          });
        const catSelect = document.createElement('select');
        catSelect.onchange = e => products[i].category = e.target.value;
        catSelect.append(...catCell.children);
        row.appendChild(catSelect);

        // brand
        const brandSelect = document.createElement('select');
        brands.forEach(b => {
          const o = document.createElement('option');
          o.value = o.textContent = b;
          if(p.brand===b) o.selected = true;
          brandSelect.appendChild(o);
        });
        brandSelect.onchange = e => products[i].brand = e.target.value;
        row.appendChild(brandSelect);

        // colors (multi-select)
        const colorSelect = document.createElement('select');
        colorSelect.multiple = true;
        colorSelect.size = Math.min(6, colors.length);
        colors.forEach(c => {
          const o = document.createElement('option');
          o.value = c.code;
          o.textContent = c.name;
          if(p.colors.includes(c.code)) o.selected = true;
          colorSelect.appendChild(o);
        });
        colorSelect.onchange = e => {
          products[i].colors = Array.from(e.target.selectedOptions).map(o=>o.value);
        };
        row.appendChild(colorSelect);

        // price
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.value = p.price;
        priceInput.onchange = e => products[i].price = parseFloat(e.target.value);
        row.appendChild(priceInput);

        // action
        const del = document.createElement('button');
        del.textContent = 'üóë Supprimer';
        del.onclick = () => deleteProduct(i);
        row.appendChild(del);

        tbody.appendChild(row);
      });
    }

    function enableDragAndDrop() {
      new Sortable(document.getElementById('productTableBody'), {
        animation: 150,
        onEnd(evt) {
          const [m] = products.splice(evt.oldIndex,1);
          products.splice(evt.newIndex,0,m);
          renderTable(); // re-render to sync selects
        }
      });
    }

    function addProduct() {
      products.push({
        title:'', platform:'', id:'', image:'',
        category:'Mode Homme',
        brand: brands[0] || '',
        colors: [],
        price: 0,
        cnfans_link:'', source:''
      });
      renderTable();
    }

    function deleteProduct(i) {
      products.splice(i,1); renderTable();
    }

    function downloadJSON() {
      products.forEach(p => {
        p.cnfans_link = `https://cnfans.com/product?platform=${p.platform}&id=${p.id}&ref=212491`;
        p.source     = `https://www.cnfans.com/product?id=${p.id}&platform=${p.platform}`;
      });
      const blob = new Blob([JSON.stringify(products, null, 2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'jadeship_products.json';
      a.click();
    }
  </script>
</body>
</html>
