<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Produits CNFANS</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 5px; box-sizing: border-box; }
    select[multiple] { height: 100px; }
    button { margin: 5px; padding: 6px 12px; }

    /* **** AJOUT : largeur r√©duite de la colonne Prix **** */
    th.price-column, td.price-column {
      width: 80px;        /* Ajuste cette valeur √† 50 % de ton width initiale */
      max-width: 80px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
  <header><h1>üõ†Ô∏è Interface Admin ‚Äì Produits CNFANS</h1></header>

  <input type="file" id="fileInput" accept=".json"><br><br>
  <button onclick="addProduct()">‚ûï Ajouter un produit</button>
  <button onclick="downloadJSON()">üíæ T√©l√©charger JSON</button>

  <table id="productTable">
    <thead>
      <tr>
        <th>Titre</th>
        <th>Plateforme</th>
        <th>ID</th>
        <th>Image</th>
        <th>Cat√©gorie</th>
        <th>Marque</th>
        <th>Couleurs</th>
        <!-- on ajoute la classe price-column -->
        <th class="price-column">Prix (‚Ç¨)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>

  <script>
    let products = [];
    let brands = [];
    let colors = [];

    // Charger marques et couleurs
    fetch('brands.json')
      .then(r=>r.json()).then(data=>brands=data.sort((a,b)=>a.localeCompare(b,'fr')));
    fetch('colors.json')
      .then(r=>r.json()).then(data=>colors=data);

    document.getElementById('fileInput').addEventListener('change', e => {
      const reader = new FileReader();
      reader.onload = () => {
        products = JSON.parse(reader.result);
        renderTable();
        enableDragAndDrop();
      };
      reader.readAsText(e.target.files[0]);
    });

    function renderTable() {
      const tbody = document.getElementById('productTableBody');
      tbody.innerHTML = '';

      products.forEach((p, i) => {
        const row = document.createElement('tr');
        // Titre / plateforme / id / image
        row.innerHTML = `
          <td><input value="${p.title||''}" onchange="products[${i}].title=this.value"></td>
          <td><input value="${p.platform||''}" onchange="products[${i}].platform=this.value"></td>
          <td><input value="${p.id||''}" onchange="products[${i}].id=this.value"></td>
          <td><input value="${p.image||''}" onchange="products[${i}].image=this.value"></td>
        `;

        // Cat√©gorie
        const catCell = document.createElement('td');
        const catSelect = document.createElement('select');
        ['Mode Homme','Mode Femme','Accessoires','Chaussures']
          .forEach(optVal => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = optVal;
            if (p.category===optVal) opt.selected = true;
            catSelect.appendChild(opt);
          });
        catSelect.onchange = e => products[i].category = e.target.value;
        catCell.appendChild(catSelect);
        row.appendChild(catCell);

        // Marque
        const brandCell = document.createElement('td');
        const brandSelect = document.createElement('select');
        brands.forEach(br => {
          const opt = document.createElement('option');
          opt.value = opt.textContent = br;
          if (p.brand===br) opt.selected = true;
          brandSelect.appendChild(opt);
        });
        brandSelect.onchange = e => products[i].brand = e.target.value;
        brandCell.appendChild(brandSelect);
        row.appendChild(brandCell);

        // Couleurs (multi-select)
        const colorCell = document.createElement('td');
        const colorSelect = document.createElement('select');
        colorSelect.multiple = true;
        colors.forEach(col => {
          const opt = document.createElement('option');
          opt.value = col.code;
          opt.textContent = col.name;
          if (Array.isArray(p.colors) && p.colors.includes(col.code)) opt.selected = true;
          colorSelect.appendChild(opt);
        });
        colorSelect.onchange = e => {
          products[i].colors = Array.from(e.target.selectedOptions).map(o=>o.value);
        };
        colorCell.appendChild(colorSelect);
        row.appendChild(colorCell);

        // Prix
        const priceCell = document.createElement('td');
        priceCell.classList.add('price-column');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.value = p.price||0;
        priceInput.onchange = e => products[i].price = parseFloat(e.target.value);
        priceCell.appendChild(priceInput);
        row.appendChild(priceCell);

        // Actions
        const actionCell = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóë Supprimer';
        delBtn.onclick = () => deleteProduct(i);
        actionCell.appendChild(delBtn);
        row.appendChild(actionCell);

        tbody.appendChild(row);
      });
    }

    function enableDragAndDrop() {
      new Sortable(document.getElementById('productTableBody'), {
        animation: 150,
        onEnd: evt => {
          const [moved] = products.splice(evt.oldIndex, 1);
          products.splice(evt.newIndex, 0, moved);
        }
      });
    }

    function addProduct() {
      products.push({
        title:'', platform:'', id:'', image:'',
        category:'Mode Homme',
        brand: brands[0]||'',
        colors: [],
        price:0,
        cnfans_link:'', source:''
      });
      renderTable();
    }

    function deleteProduct(i) {
      products.splice(i,1);
      renderTable();
    }

    function downloadJSON() {
      products.forEach(p => {
        p.cnfans_link = `https://cnfans.com/product?platform=${p.platform}&id=${p.id}&ref=212491`;
        p.source     = `https://www.cnfans.com/product?id=${p.id}&platform=${p.platform}`;
      });
      const blob = new Blob([JSON.stringify(products,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'jadeship_products.json';
      a.click();
    }
  </script>
</body>
</html>
