<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Produits CNFANS</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    input, select { width: 100%; padding: 5px; box-sizing: border-box; }
    select[multiple] { height: 100px; }
    button { margin: 5px; padding: 6px 12px; }
    th.price-column, td.price-column { width: 80px; max-width: 80px; }

    /* Boutons flottants */
    #addBtn, #commitBtn {
      position: fixed; bottom: 20px; z-index: 1000;
      width: 50px; height: 50px; border-radius: 50%;
      background-color: #007bff; color: white; font-size: 24px;
      border: none; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background-color 0.2s;
    }
    #addBtn { right: 20px; }
    #addBtn:hover { background-color: #0056b3; }
    #commitBtn {
      right: 80px;
      background-color: #28a745;
    }
    #commitBtn:hover { background-color: #1e7e34; }

    /* Overlays */
    #pw-overlay, #token-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8); display: flex;
      justify-content: center; align-items: center; z-index:1000;
    }
    .prompt-box {
      background: #fff; padding: 20px; border-radius: 8px;
      text-align: center; width: 300px;
    }
    .prompt-box input { width: calc(100% - 20px); padding: 8px; margin-bottom: 10px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
  <!-- 1) Overlay mot de passe -->
  <div id="pw-overlay">
    <div class="prompt-box">
      <h2>AccÃ¨s Admin</h2>
      <input type="password" id="adminPwd" placeholder="Entrez le mot de passe"><br>
      <button onclick="checkPwd()">Valider</button>
      <p>Vous avez 15 secondes pour saisir.</p>
    </div>
  </div>

  <!-- 2) Overlay GitHub Token -->
  <div id="token-overlay" style="display:none">
    <div class="prompt-box">
      <h2>GitHub Token</h2>
      <p>Entrez un <em>Personal Access Token</em> (scope <code>repo</code>) :</p>
      <input type="password" id="ghToken" placeholder="ghp_xxxâ€¦"><br>
      <button onclick="saveToken()">Enregistrer</button>
    </div>
  </div>

  <header><h1>ğŸ› ï¸ Interface Admin â€“ Produits CNFANS</h1></header>

  <!-- 3) Boutons flottants dâ€™action -->
  <button id="addBtn" title="Ajouter un produit" onclick="addProduct()">ï¼‹</button>
  <button id="commitBtn" title="Commit to GitHub" onclick="commitToGitHub()">ğŸš€</button>
  <button onclick="downloadJSON()">ğŸ’¾ TÃ©lÃ©charger JSON</button>

  <table id="productTable">
    <thead>
      <tr>
        <th>Titre</th><th>Plateforme</th><th>ID</th><th>Image</th>
        <th>CatÃ©gorie</th><th>Marque</th><th>Couleurs</th>
        <th class="price-column">Prix (CNY)</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>

  <script>
  // â”€â”€â”€ CONFIGURATION GITHUB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const githubConfig = {
    owner:  'stoxor-web',
    repo:   'vitrine-cnfans',
    path:   'jadeship_products.json',
    branch: 'main'
  };

  // â”€â”€â”€ OVERLAY MOT DE PASSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const correctPwd = '123456';
  let pwdTimer = setTimeout(() => {
    alert('Temps Ã©coulÃ© â€“ accÃ¨s refusÃ©');
    window.location.href = 'index.html';
  }, 15000);

  function checkPwd(){
    if (document.getElementById('adminPwd').value === correctPwd) {
      clearTimeout(pwdTimer);
      document.getElementById('pw-overlay').style.display = 'none';
      if (!localStorage.getItem('ghToken')) {
        document.getElementById('token-overlay').style.display = 'flex';
      } else {
        loadFromGitHub();
      }
    } else {
      alert('Mot de passe incorrect');
    }
  }

  // â”€â”€â”€ GESTION DU GITHUB TOKEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveToken(){
    const t = document.getElementById('ghToken').value.trim();
    if (!t) return alert('Token requis');
    localStorage.setItem('ghToken', t);
    document.getElementById('token-overlay').style.display = 'none';
    loadFromGitHub();
  }
  function getToken(){ return localStorage.getItem('ghToken'); }

  function showGitHubTokenOverlay() {
    document.getElementById('token-overlay').style.display = 'flex';
  }

  // â”€â”€â”€ CHARGEMENT FROM GITHUB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadFromGitHub(){
    try {
      const token = getToken();
      if (!token) throw new Error('Token manquant');
      const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}?ref=${githubConfig.branch}`;
      const res = await fetch(url, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!res.ok) throw new Error(`Impossible de charger le JSON depuis GitHub (${res.status} ${res.statusText})`);
      const { content } = await res.json();
      products = JSON.parse(atob(content));
      renderTable();
      enableDragAndDrop();
    } catch(err) {
      console.error(err);
      localStorage.removeItem('ghToken');
      alert(err.message + '\nVeuillez saisir un nouveau token.');
      showGitHubTokenOverlay();
    }
  }

  // â”€â”€â”€ CHARGEMENT DES LISTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let products = [], brands = [], categories = [], colors = [];
  fetch('categories.json').then(r=>r.json()).then(d=>categories=d.sort((a,b)=>a.localeCompare(b,'fr')));
  fetch('brands.json').then(r=>r.json()).then(d=>brands=d.sort((a,b)=>a.localeCompare(b,'fr')));
  fetch('colors.json').then(r=>r.json()).then(d=>colors=d);

  // â”€â”€â”€ RENDER TABLEAU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable(){ /* ... existing renderTable code unchanged ... */ }

  // â”€â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function enableDragAndDrop(){ /* ... existing drag & drop code unchanged ... */ }

  // â”€â”€â”€ AJOUT / SUPPRESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addProduct(){ /* ... */ }
  function deleteProduct(idx){ /* ... */ }

  // â”€â”€â”€ EXPORT LOCAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function downloadJSON(){ /* ... */ }

  // â”€â”€â”€ COMMIT TO GITHUB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function commitToGitHub(){ /* ... */ }
  </script>
</body>
</html>
